---
layout:     post
title:      reading-note-csapp
date:       2018-03-14 21:48:00
author:     "Hou"
header-img: "img/post-bg-computer-science.jpg"
tags:
    - note
    - csapp
---
第九章-虚拟内存小结
============

虚拟内存提供了三个重要的能力：

1. 它将主存看成是一个存储在磁盘上的地址空间的高速缓存，在主存中只保存活动区域，并更具需要在磁盘和主存之间来回传送数据，通过这种方式，它高效的使用了主存。

2. 它为每个进程提供了一致的地址空间，从而简化了内存管理。

3. 它保护了每个进程的地址空间不被其他进程破坏。

### 9.1 物理和虚拟寻址

计算机系统的主存被组织成一个由M个连续的字节大小的单元组成的数组。每字节都有一个唯一的物理地址（Physical Address）。给定这种简单的结构，CPU访问内存的最自然的方式就是使用物理地址。我们把这种方式称为物理寻址（physical addressing）。

现代处理器使用的是一种称为虚拟寻址（virtual addressing）的寻址形式。CPU通过生成一个虚拟地址（Virtual Address）来访问主存，这个虚拟地址被送到内存之前先转换成适当的物理地址。转换的任务叫做地址翻译（address translation）。CPU芯片上叫做内存管理单元（Memory Management Unit）的专用硬件，利用存放在主存中的查询表来动态翻译虚拟地址。（为什么觉得是在脱裤子放屁呢？）


### 9.2 地址空间

地址空间（address space）是一个非负整数地址的有序集合。如果地址空间中的整数是连续的，那么我们说它是一个线性地址空间（linear address space）。一个有N=2^n个地址的地址空间称为n位地址空间。

一个系统还有一个物理地址空间（physical address space），对应于系统中物理内存M个字节，M不要求是2的幂。


### 9.3 虚拟内存作为缓存的工具

VM系统通过将虚拟内存分割为虚拟页（Virtual Page）大小固定的块，每个虚拟页的大小为P=2^p字节。类似的，物理内存被分割为物理页（Physical Page），大小也为P字节。

在任意时刻，虚拟页面的集合都分为三个不相交的子集：

- 未分配的：VM系统还未分配（或创建）的页。未分配的块没有任何数据和它们相关联，因此也就不占用任何磁盘空间。

- 缓存的：当前已缓存在物理内存中的已分配页。

- 未缓存的：未缓存在物理内存中的已分配页。

*9.3.1 DRAM缓存的组织结构*

DRAM比SRAM慢大约10倍，磁盘比DRAM慢大约100000多倍。因此DRAM缓存中的不命中比起SRAM缓存中的不命中要昂贵的多。因此虚拟页往往很大，通常是4KB~2MB，DRAM缓存是全相联的，即任何虚拟页都可以放置在任何的物理页中。

*9.3.2 页表*

页表是一个存放在物理内存中的数据结构，它将虚拟页映射到物理页。每次地址翻译硬件将一个虚拟地址转换为物理地址时，都会读取页表。

页表就是一个页表条目（Page Table Entry，PTE）的数组。虚拟地址空间中的每个页在页表中一个固定偏移量处都有一个PTE。我们假设每个PTE是由一个有效位（valid bit）和一个n位地址字段组成的。有效位表明了该虚拟页当前是否被缓存在DRAM中。

*9.3.4 缺页*

如果CPU引用了某个虚拟页中的一个字，而这个虚拟页没有被缓存在DRAM中，称为缺页。此时缺页异常会调用内核中的缺页异常处理程序，该程序会选择一个牺牲页，如果此牺牲页已经被修改了，内核就会将它复制回磁盘。接下来，内核从磁盘复制需要的虚拟页到内存中的物理页，更新PTE对应位置，随后返回。返回后，会重新启动导致缺页的指令，该指令会把导致缺页的虚拟地址重发送到地址翻译硬件。


### 9.4 虚拟内存作为内存管理的工具

操作系统为每个进程提供了一个独立的页表，因而也就是一个独立的虚拟地址空间。

![](/img/post/post-2018-02-28-37.jpg)


### 9.5 虚拟内存作为内存保护的工具

现代计算机系统必须为操作系统提供手段来控制对内存系统的访问。不应该允许一个用户进程修改它的只读代码段。而且也不应该允许它读或修改任何内核中的代码和数据结构。不应该允许它读或者写其他进程的私有内存，并且不允许它修改任何与其他进程共享的虚拟页面，除非所有的共享者都显式地允许它这么做。


### 9.6 地址翻译

![](/img/post/post-2018-02-28-38.jpg)

![](/img/post/post-2018-02-28-39.jpg)

*9.6.2 利用TLB加速地址翻译*

翻译后备缓冲器（Translation Lookaside Buffer，TLB）是一个小的、虚拟寻址的缓存，其中每一行都保存着一个由单个PTE组成的块。

*9.6.3 多级页表*

![](/img/post/post-2018-02-28-40.jpg)


### 9.8 内存映射

Linux通过将一个虚拟内存区域与一个磁盘上的对象关联起来，以初始化这个虚拟内存区域的内容成为内存映射（memory mapping）。虚拟内存区域可以映射到两种类型的对象中的一种：

1. Linux文件系统中的普通文件：一个区域可以映射到一个普通磁盘文件的连续部分，例如一个可执行目标文件。文件区（sectino）被分成页大小的片，每一片包含一个虚拟页面的初始内容。

2. 匿名文件：一个区域也可以映射到一个匿名文件，匿名文件是由内核创建的，包含的全是二进制零。CPU第一次引用这样一个区域内的虚拟页面时，内核就在屋里内存中找到一个合适的牺牲页面